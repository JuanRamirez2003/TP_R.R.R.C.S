<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Supervisor - Local</title>
<link rel="stylesheet" href="css/ventas.css">
<style>
/* --- Aqu√≠ va todo tu CSS que me pasaste --- */
/* Reset */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Dashboard */
.dashboard {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    width: 220px;
    background-color: #1e1e1e;
    color: #e0e0e0;
    padding: 20px;
    border-right: 1px solid #333;
}

.sidebar h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #55a630;
}

.sidebar ul {
    list-style: none;
}

.sidebar ul li {
    margin-bottom: 15px;
}

.sidebar button {
    width: 100%;
    padding: 10px;
    border: none;
    background-color: #2a2a2a;
    color: #e0e0e0;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: 0.3s;
}

.sidebar button:hover {
    background-color: #55a630;
    color: #000;
}

/* Main */
.main-content {
    flex: 1;
    padding: 30px;
    background-color: #121212;
    color: #e0e0e0;
}

/* Encabezados */
h1, h2 {
    color: #ffffff;
    margin-bottom: 20px;
}

/* Secci√≥n */
.seccion {
    background-color: #1e1e1e;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0px 2px 8px rgba(0,0,0,0.5);
    margin-bottom: 20px;
}

/* Formularios */
form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    grid-column: span 2;
}

.form-group input,
.form-group select {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #333;
    margin-top: 5px;
    font-size: 14px;
    background-color: #2a2a2a;
    color: #e0e0e0;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    border-color: #55a630;
    box-shadow: 0 0 5px rgba(85, 166, 48, 0.3);
}

/* Botones */
.btn-submit {
    grid-column: span 2;
    padding: 12px;
    background-color: #55a630;
    color: #000;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    transition: 0.3s;
}

.btn-submit:hover {
    background-color: #4a8c2a;
    color: #fff;
}

/* Tablas */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 14px;
    background-color: #2a2a2a;
    border-radius: 6px;
    overflow: hidden;
}

th, td {
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid #333;
    color: #e0e0e0;
}

th {
    background-color: #1e1e1e;
}

tr:hover {
    background-color: #3e3e3e;
}

/* Productos din√°micos */
.producto-item {
    display: flex;
    gap: 10px;        
    align-items: center;
    margin-bottom: 10px;
}

.producto-item select,
.producto-item input {
    padding: 5px;
    font-size: 14px;
    background-color: #2a2a2a;
    border: 1px solid #333;
    color: #e0e0e0;
    border-radius: 4px;
}

.producto-item button {
    padding: 5px 10px;
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.producto-item button:hover {
    background-color: #a71d2a;
}

/* Bot√≥n editar */
.btn-editar {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: 0.3s;
}

.btn-editar:hover {
    background-color: #0056b3;
}

/* Bot√≥n eliminar */
.btn-eliminar {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: 0.3s;
    margin-left: 5px;
}

.btn-eliminar:hover {
    background-color: #a71d2a;
}

/* Responsive */
@media (max-width: 900px) {
    .dashboard {
        flex-direction: column;
    }

    .sidebar {
        width: 100%;
        flex-direction: row;
        justify-content: space-around;
        padding: 15px 0;
        border-right: none;
        border-bottom: 1px solid #333;
    }

    form {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>
<div class="dashboard">
  <aside class="sidebar">
    <h2>Supervisor</h2>
    <button onclick="mostrarSeccion('ordenProduccion')">Creaci√≥n OP</button>
    <button onclick="mostrarSeccion('seguimientoOP'); cargarOP()">Seguimiento OP</button>
  </aside>

  <main class="main-content">
    <h1>Panel de Supervisor</h1>

    <!-- CREACI√ìN OP -->
    <div id="ordenProduccion" class="seccion" style="display:none;">
      <h2>Creaci√≥n de Orden de Producci√≥n</h2>
      <form id="opForm">
        <div class="form-group">
          <label for="opNumero">N√∫mero de OP:</label>
          <input type="text" id="opNumero" readonly required>
        </div>
        <div class="form-group">
          <label>Productos:</label>
          <div id="productosContainer"></div>
          <button type="button" onclick="agregarProducto()" class="agregarProducto btn-submit">‚ûï Agregar Producto</button>
        </div>
        <button type="submit" class="btn-submit">Crear OP</button>
        <button type="button" onclick="cancelarOP()" class="btn-eliminar">Cancelar</button>
      </form>
    </div>

    <!-- SEGUIMIENTO OP -->
    <div id="seguimientoOP" class="seccion" style="display:none;">
      <h2>Seguimiento de √ìrdenes de Producci√≥n</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Numero de OP</th>
              <th>Orden</th>
              <th>Estado</th>
              <th>Fecha Emisi√≥n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaOP"></tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<!-- Modal Ver Orden -->
<div class="modal" id="modalOrden" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.7); justify-content:center; align-items:center;">
  <div class="modal-content" style="background-color:#1e1e1e; padding:20px; border-radius:10px; width:90%; max-width:500px; position:relative;">
    <span class="close-modal" onclick="cerrarModal()" style="position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer; color:#fff;">&times;</span>
    <h2>Detalle de Orden</h2>
    <div id="detalleOrden"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabaseUrl = "https://ldgrlfnmuvvaqsezjsvj.supabase.co";
    const supabaseKey =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkZ3JsZm5tdXZ2YXFzZXpqc3ZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MzEwNDMsImV4cCI6MjA3NDUwNzA0M30.NrUTqCLkzMWUGqn2XIAsCY8H90vgHpuxhMT2zIVt3Zo";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

function mostrarSeccion(id){
  document.querySelectorAll('.seccion').forEach(s=>s.style.display='none'); 
  document.getElementById(id).style.display='block'; 
  if(id==="ordenProduccion") prepararNuevaOP();
  if(id==="seguimientoOP") cargarOP();
}

// Inicializamos el array vac√≠o
let productosDisponibles = [];

async function cargarProductosDisponibles() {
  const { data, error } = await supabaseClient.from('productos').select('nombre');

  if (error) {
    console.error("Error al cargar productos:", error);
    return;
  }

  productosDisponibles = data.map(p => p.nombre);
  console.log("Productos disponibles:", productosDisponibles);
}

// Llamada de ejemplo:
(async () => {
  await cargarProductosDisponibles();
  agregarProducto(); // Ahora tendr√° los productos cargados
})();

let ordenesProduccion = JSON.parse(localStorage.getItem("ordenesProduccion")) || [];
function guardarOPs() { localStorage.setItem("ordenesProduccion", JSON.stringify(ordenesProduccion)); }

async function generarNumeroOP() {
  const a√±o = 2025;

  // Traemos todos los numero_op existentes de este a√±o
  const { data, error } = await supabaseClient
      .from('orden_produccion')
      .select('numero_op');

  if(error){
      console.error("Error al obtener OP existentes:", error);
      return `OP-${a√±o}-000`;
  }

  // Extraemos los n√∫meros y obtenemos el mayor
  let maxNum = 0;
  data.forEach(op => {
      const partes = op.numero_op.split('-');
      if(partes[1] == a√±o.toString()){
          const num = parseInt(partes[2], 10);
          if(num > maxNum) maxNum = num;
      }
  });

  const siguiente = maxNum + 1;
  return `OP-${a√±o}-${String(siguiente).padStart(3,'0')}`;
}

prepararNuevaOP();

function prepararNuevaOP() {
  document.getElementById('productosContainer').innerHTML = '';
  agregarProducto();

  generarNumeroOP().then(numeroOP => {
    document.getElementById('opNumero').value = numeroOP;
  });
}

function agregarProducto(){
  const container = document.getElementById('productosContainer');
  const div = document.createElement('div'); 
  div.className='producto-item';
  let opciones = productosDisponibles.map(p => `<option value="${p}">${p}</option>`).join('');
  div.innerHTML=`
    <select name="productoNombre[]" required>
      <option value="" disabled selected>Seleccione un producto</option>
      ${opciones}
    </select>
    <input type="number" name="productoCantidad[]" min="1" value="1" required>
    <button type="button" onclick="eliminarProducto(this)" class="btn-eliminar">‚ùå</button>
  `;
  container.appendChild(div);
}

function eliminarProducto(btn){ 
  btn.parentElement.remove(); 
  if(document.querySelectorAll('.producto-item').length===0) agregarProducto(); 
}

function cancelarOP(){ 
  document.getElementById('opForm').reset(); 
  document.getElementById('productosContainer').innerHTML=''; 
  agregarProducto(); 
  document.getElementById('ordenProduccion').style.display='none'; 
}

// Crear OP y guardar en Supabase
document.getElementById('opForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const productos = Array.from(document.querySelectorAll('.producto-item')).map(p=>({
    nombre: p.querySelector('select').value,
    cantidad: parseInt(p.querySelector('input').value,10)
  }));
  if(productos.some(p=>!p.nombre || p.cantidad<=0)){
    alert("Complete todos los productos con cantidad v√°lida");
    return;
  }

  const numeroOP = document.getElementById('opNumero').value;
  const fecha = new Date().toISOString();

  const { data, error } = await supabaseClient.from('orden_produccion').insert([{
    numero_op: numeroOP,
    ver_orden: productos,
    fecha_emision: fecha,
    estado: 'Pendiente'
  }]);

  if(error) return console.error("Error al guardar OP:", error);

  cancelarOP();
  mostrarSeccion('seguimientoOP');
  cargarOP();
});

// Cargar OP desde Supabase
async function cargarOP(){
  const { data, error } = await supabaseClient.from('orden_produccion').select('*').order('id_orden_produccion', {ascending:true});
  if(error) return console.error("Error al cargar OP:", error);

  const tabla = document.getElementById('tablaOP');
  tabla.innerHTML='';
  data.forEach(op=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${op.numero_op}</td>
      <td><button onclick="verOrden(${op.id_orden_produccion})" class="btn-editar">üìÑ Ver Orden</button></td>
      <td>${op.estado}</td>
      <td>${new Date(op.fecha_emision).toLocaleString()}</td>
      <td>
        ${op.estado==='Pendiente'
          ? `<button onclick="editarOP(${op.id_orden_produccion})" class="btn-editar">‚úèÔ∏è Editar</button>
             <button onclick="eliminarOP(${op.id_orden_produccion})" class="btn-eliminar">‚ùå Eliminar</button>`
          : 'No disponible'}
      </td>
    `;
    tabla.appendChild(tr);
  });
}

// Ver detalle de OP
async function verOrden(id_orden_produccion){
  const { data, error } = await supabaseClient.from('orden_produccion')
      .select('*').eq('id_orden_produccion', id_orden_produccion).single();
  if(error) return console.error("Error al ver OP:", error);

  const productosHtml = data.ver_orden.map(p=>`<p>${p.nombre} - Cantidad: ${p.cantidad}</p>`).join('');
  document.getElementById('detalleOrden').innerHTML=`
    <p><strong>N√∫mero OP:</strong> ${data.numero_op}</p>
    <p><strong>Fecha Emisi√≥n:</strong> ${new Date(data.fecha_emision).toLocaleString()}</p>
    <p><strong>Estado:</strong> ${data.estado}</p>
    <h4>Productos:</h4>
    ${productosHtml}
  `;
  document.getElementById('modalOrden').style.display='flex';
}

function cerrarModal(){ document.getElementById('modalOrden').style.display='none'; }

// Editar OP
async function editarOP(id_orden_produccion){
  const { data, error } = await supabaseClient.from('orden_produccion')
      .select('*').eq('id_orden_produccion', id_orden_produccion).single();
  if(error) return console.error("Error al cargar OP para editar:", error);

  const productos = data.ver_orden.map(p=>{
    const cant = prompt(`Editar cantidad de ${p.nombre}:`, p.cantidad);
    if(cant && !isNaN(cant) && cant>0) return { nombre: p.nombre, cantidad: parseInt(cant,10) };
    return p;
  });

  const { error: updateError } = await supabaseClient.from('orden_produccion')
      .update({ ver_orden: productos }).eq('id_orden_produccion', id_orden_produccion);
  if(updateError) return console.error("Error al actualizar OP:", updateError);

  cargarOP();
}

// Eliminar OP
async function eliminarOP(id_orden_produccion){
  if(!confirm("¬øEliminar esta OP?")) return;
  const { error } = await supabaseClient.from('orden_produccion')
      .delete().eq('id_orden_produccion', id_orden_produccion);
  if(error) return console.error("Error al eliminar OP:", error);
  cargarOP();
}

// Inicializaci√≥n
(async () => {
  await cargarProductosDisponibles();
  prepararNuevaOP();
})();
</script>
</body>
</html>
