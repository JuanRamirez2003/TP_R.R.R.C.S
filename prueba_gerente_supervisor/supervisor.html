<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Supervisor - Local</title>
<link rel="stylesheet" href="css/ventas.css">
<style>
  .producto-item { 
    border:1px solid #ccc; 
    padding:10px; 
    margin-bottom:10px; 
    border-radius:5px; 
    display: flex; 
    align-items: center; 
    gap: 10px;
  }
  .producto-item select, .producto-item input {
    padding:5px;
    font-size: 14px;
  }
  .mp-container { 
    max-height: 150px; 
    overflow-y: auto; 
    border:1px solid #eee; 
    padding:5px; 
    margin-top:5px; 
    border-radius:5px;
  }
  .mp-list { margin-left:20px; margin-bottom:10px; }
  .mp-list div { margin-bottom:3px; }

  button.agregarProducto {
    padding: 5px 8px;
    font-size: 14px;
    background-color: #007bff;
    color: white;
    border-radius: 4px;
    border: none;
    cursor:pointer;
  }
  button.agregarProducto:hover {
    background-color: #0056b3;
  }

  @media(max-width:600px){
    .dashboard{display:block;}
    .sidebar{width:100%; margin-bottom:10px;}
    .main-content{width:100%;}
    input, select, button { width: 100%; margin-top:5px; }
    .mp-container { max-height: 200px; }
  }
</style>
</head>
<body>
<div class="dashboard">
  <aside class="sidebar">
    <h2>Supervisor</h2>
    <button onclick="mostrarSeccion('ordenProduccion')">Creaci√≥n OP</button>
    <button onclick="mostrarSeccion('seguimientoOP'); cargarOP()">Seguimiento OP</button>
  </aside>

  <main class="main-content">
    <h1>Panel de Supervisor</h1>

    <!-- CREACI√ìN OP -->
    <div id="ordenProduccion" class="seccion" style="display:none;">
      <h2>Creaci√≥n de Orden de Producci√≥n</h2>
      <form id="opForm">
        <div class="form-group">
          <label for="opNumero">N√∫mero de OP:</label>
          <input type="text" id="opNumero" readonly required>
        </div>
        <div class="form-group">
          <label>Productos:</label>
          <div id="productosContainer"></div>
          <button type="button" onclick="agregarProducto()" class="agregarProducto">‚ûï Agregar Producto</button>
        </div>
        <button type="submit" class="btn-submit">Crear OP</button>
        <button type="button" onclick="cancelarOP()" class="btn-eliminar">Cancelar</button>
      </form>
    </div>

    <!-- SEGUIMIENTO OP -->
    <div id="seguimientoOP" class="seccion" style="display:none;">
      <h2>Seguimiento de √ìrdenes de Producci√≥n</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Orden</th>
            <th>Estado</th>
            <th>Fecha Emisi√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaOP"></tbody>
      </table>
    </div>
  </main>
</div>

<!-- Modal Ver Orden -->
<div class="modal" id="modalOrden">
  <div class="modal-content">
    <span class="close-modal" onclick="cerrarModal()">&times;</span>
    <h2>Detalle de Orden</h2>
    <div id="detalleOrden"></div>
  </div>
</div>

<script>
let ordenesProduccion = JSON.parse(localStorage.getItem("ordenesProduccion")) || [];
const productosDisponibles = ["Medall√≥n de Pollo", "Arvejas", "Choclo", "Patitas de Pollo", "Milanesa de Carne"];

// Guardar OPs
function guardarOPs() { localStorage.setItem("ordenesProduccion", JSON.stringify(ordenesProduccion)); }

function mostrarSeccion(id){
  document.querySelectorAll('.seccion').forEach(s=>s.style.display='none'); 
  document.getElementById(id).style.display='block'; 
  if(id==="ordenProduccion") prepararNuevaOP();
  if(id==="seguimientoOP") cargarOP();
}

// Generar n√∫mero incremental de OP
function generarNumeroOP(){
  const a√±o = 2025;
  const numero = (ordenesProduccion.length + 1).toString().padStart(3,"0");
  return `OP-${a√±o}-${numero}`;
}

// Preparar nueva OP
function prepararNuevaOP(){
  document.getElementById("opNumero").value = generarNumeroOP();
  document.getElementById('productosContainer').innerHTML='';
  agregarProducto();
}

// Productos din√°micos
function agregarProducto(){
  const container = document.getElementById('productosContainer');
  const div = document.createElement('div'); 
  div.className='producto-item';
  let opciones = productosDisponibles.map(p => `<option value="${p}">${p}</option>`).join('');
  div.innerHTML=`
    <select name="productoNombre[]" required>
      <option value="" disabled selected>Seleccione un producto</option>
      ${opciones}
    </select>
    <input type="number" name="productoCantidad[]" min="1" value="1" required>
    <button type="button" onclick="eliminarProducto(this)" class="btn-eliminar">‚ùå</button>
  `;
  container.appendChild(div);
}

function eliminarProducto(btn){ 
  btn.parentElement.remove(); 
  if(document.querySelectorAll('.producto-item').length===0) agregarProducto(); 
}

function cancelarOP(){ 
  document.getElementById('opForm').reset(); 
  document.getElementById('productosContainer').innerHTML=''; 
  agregarProducto(); 
  document.getElementById('ordenProduccion').style.display='none'; 
}

// Crear OP
document.getElementById('opForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  // Validar productos
  const productos = Array.from(document.querySelectorAll('.producto-item')).map(p=>({
    nombre:p.querySelector('select').value,
    cantidad:p.querySelector('input').value
  }));
  if(productos.some(p=>!p.nombre || p.cantidad<=0)){
    alert("Complete todos los productos con cantidad v√°lida");
    return;
  }

  const nuevaOP = {
    opNumero: document.getElementById('opNumero').value,
    productos,
    estado:'Pendiente',
    fecha_emision:new Date().toISOString()
  };

  ordenesProduccion.push(nuevaOP);
  guardarOPs();
  cancelarOP();
  mostrarSeccion('seguimientoOP');
  cargarOP();
});

// Cargar OPs en tabla
function cargarOP(){
  const tabla = document.getElementById('tablaOP'); 
  tabla.innerHTML='';
  ordenesProduccion.forEach(op=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${op.opNumero}</td>
      <td><button onclick="verOrden('${op.opNumero}')" class="btn-editar">üìÑ Ver Orden</button></td>
      <td>${op.estado}</td>
      <td>${new Date(op.fecha_emision).toLocaleString()}</td>
      <td>
        ${op.estado==='Pendiente'
          ? `<button onclick="editarOP('${op.opNumero}')" class="btn-editar">‚úèÔ∏è Editar</button>
             <button onclick="eliminarOP('${op.opNumero}')" class="btn-eliminar">‚ùå Eliminar</button>`
          : 'No disponible'}
      </td>
    `;
    tabla.appendChild(tr);
  });
}

// Modal
function verOrden(opNumero){
  const op = ordenesProduccion.find(o=>o.opNumero===opNumero); 
  if(!op) return;
  let productosHtml = op.productos.map(p => `<p>${p.nombre} - Cantidad: ${p.cantidad}</p>`).join('');
  document.getElementById('detalleOrden').innerHTML=`
    <p><strong>N√∫mero OP:</strong> ${op.opNumero}</p>
    <p><strong>Fecha Emisi√≥n:</strong> ${new Date(op.fecha_emision).toLocaleString()}</p>
    <p><strong>Estado:</strong> ${op.estado}</p>
    <h4>Productos:</h4>
    ${productosHtml}
  `;
  document.getElementById('modalOrden').style.display='flex';
}

function cerrarModal(){
  document.getElementById('modalOrden').style.display='none';
}

// Editar OP
function editarOP(opNumero){
  const op = ordenesProduccion.find(o=>o.opNumero===opNumero); 
  if(!op) return;
  op.productos.forEach(p=>{
    const cant = prompt(`Editar cantidad de ${p.nombre}:`, p.cantidad);
    if(cant && !isNaN(cant) && cant>0) p.cantidad = cant;
  });
  guardarOPs();
  cargarOP();
}

// Eliminar OP
function eliminarOP(opNumero){
  if(confirm(`¬øEliminar OP ${opNumero}?`)){
    ordenesProduccion = ordenesProduccion.filter(o=>o.opNumero!==opNumero);
    guardarOPs();
    cargarOP();
  }
}

// Inicial
prepararNuevaOP();
</script>
</body>
</html>
